<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{% block title %}WeeklyBuddy{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Pre-paint: set theme + sidebar collapsed state before CSS to prevent flicker -->
  <script>
    (function () {
      // Theme
      const KEY = 'wb-theme';
      let mode = null;
      try { mode = localStorage.getItem(KEY); } catch(_) {}
      if (mode === 'dark') mode = 'Dark';
      if (mode === 'light') mode = 'Light';
      if (!['Light','Dark','Auto'].includes(mode)) {
        mode = "{{ (settings.theme or 'Light') }}";
      }
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const dark = (mode === 'Dark') || (mode === 'Auto' && prefersDark);
      document.documentElement.classList.toggle('dark', dark);
      document.body && document.body.classList.toggle('dark', dark);

      // Sidebar collapsed
      let collapsed = 'false';
      try { collapsed = localStorage.getItem('wb-nav-collapsed') || 'false'; } catch(_) {}
      if (collapsed === 'true') document.documentElement.classList.add('nav-collapsed');
    })();
  </script>

  <!-- App CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='ai-theme.css') }}">

  <!-- Minimal tokens + sidebar/controls styles -->
  <style>
    :root{
      --bg: #f5f7fb;
      --text: #0f172a;
      --muted:#64748b;
      --card:#ffffff;
      --card-brd:#e5e7eb;
      --accent:#2563eb;
      --accent-2:#8b5cf6;
      --shadow: 0 8px 24px rgba(15,23,42,.08);
      --radius: 14px;
      --nav-w: 260px;
      --nav-w-collapsed: 76px;
      --nav-item: #ffffff;
      --nav-item-active: #eef2ff;
      --nav-border: #e5e7eb;
    }
    html.dark{
      --bg:#0b1220;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --card:#0f1629;
      --card-brd:#1f2a3a;
      --accent:#60a5fa;
      --accent-2:#a78bfa;
      --shadow: 0 10px 28px rgba(2,6,23,.35);
      --nav-item:#0f1629;
      --nav-item-active:#101a33;
      --nav-border:#1f2a3a;
    }
    body{ background:var(--bg); color:var(--text); }
    .card{ background:var(--card); border:1px solid var(--card-brd); border-radius:var(--radius); box-shadow:var(--shadow); }
    .muted{ color:var(--muted); }
    .btn.ghost{ background:transparent; color:inherit; border:1px solid var(--card-brd); border-radius:10px; padding:8px 12px; }
    .switch{ position:relative; display:inline-block; width:42px; height:24px; }
    .switch input{ display:none; }
    .switch .slider{ position:absolute; inset:0; background:#cbd5e1; border-radius:999px; transition:.2s; }
    .switch .slider::after{ content:''; position:absolute; top:3px; left:3px; width:18px; height:18px; background:#fff; border-radius:999px; transition:.2s; }
    .switch input:checked + .slider{ background:var(--accent); }
    .switch input:checked + .slider::after{ transform: translateX(18px); }

    /* Layout */
    .shell{ display:flex; min-height:100vh; }
    .sidebar{
      width:var(--nav-w);
      background:var(--card);
      border-right:1px solid var(--nav-border);
      padding:14px 12px;
      position:sticky; top:0; height:100vh;
      display:flex; flex-direction:column; gap:8px;
      transition: width .22s ease;
    }
    .brand{
      display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:12px;
      font-weight:800;
    }
    .brand-bubble{
      width:36px; height:36px; border-radius:999px; display:grid; place-items:center;
      color:#fff; font-weight:900;
      background:linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow:0 8px 20px rgba(37,99,235,.25);
      flex:0 0 36px;
    }
    .brand-name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .nav{ display:flex; flex-direction:column; gap:6px; margin-top:4px; }
    .nav-item{
      display:flex; align-items:center; gap:12px;
      padding:10px 12px; border-radius:12px;
      background:var(--nav-item); border:1px solid var(--nav-border);
      font-weight:700; text-decoration:none; color:inherit;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      position:relative;
    }
    .nav-item:hover{ transform: translateX(2px); border-color:#c7d2fe; }
    .nav-item .nav-ico{ font-size:18px; width:20px; text-align:center; }
    .nav-item.active{
      background:var(--nav-item-active); border-color:#c7d2fe;
      box-shadow: inset 3px 0 0 0 var(--accent);
    }
    .nav-item.active .nav-ico{ filter: saturate(1.3); }
    .nav-item .nav-label{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .sidebar-footer{ margin-top:auto; display:flex; justify-content:flex-end; }
    .nav-toggle{
      display:flex; align-items:center; gap:8px; border:1px solid var(--nav-border);
      background:var(--nav-item); padding:8px 10px; border-radius:10px; cursor:pointer;
      font-weight:700;
    }

    .content{
      flex:1; padding:20px; max-width:1600px; margin:0 auto; width:100%;
    }

    /* Collapsed state */
    html.nav-collapsed .sidebar{ width:var(--nav-w-collapsed); }
    html.nav-collapsed .brand-name{ display:none; }
    html.nav-collapsed .nav-item .nav-label{ display:none; }
    html.nav-collapsed .sidebar-footer .nav-toggle .txt{ display:none; }

    /* Flash */
    .flash-container{ margin:6px 0 12px; }
    .flash{ padding:10px 12px; border-radius:10px; border:1px solid var(--card-brd); background:var(--card); }
    .flash-success{ border-color:#86efac; background:rgba(22,163,74,.08); }
    .flash-warning{ border-color:#facc15; background:rgba(234,179,8,.08); }
    .flash-danger{ border-color:#fca5a5; background:rgba(239,68,68,.08); }
  </style>
</head>
<body>

<div class="shell">
  <!-- Sidebar -->
  <aside class="sidebar" role="navigation" aria-label="Main">
    <div class="brand" title="{{ settings.bot_name or 'WeeklyBuddy' }}">
      <div class="brand-bubble">{{ (settings.bot_name or 'WeeklyBuddy')[:1] }}</div>
      <div class="brand-name">{{ settings.bot_name if settings else "WeeklyBuddy" }}</div>
    </div>

    <nav class="nav">
      <a class="nav-item {% if request.path == '/' or request.path.startswith('/dashboard') %}active{% endif %}"
         href="{{ url_for('dashboard') }}" title="Dashboard">
        <span class="nav-ico">üìä</span><span class="nav-label">Dashboard</span>
      </a>
      <a class="nav-item {% if request.path.startswith('/people') or request.path == '/person' %}active{% endif %}"
         href="{{ url_for('person') }}" title="Team Members">
        <span class="nav-ico">üë•</span><span class="nav-label">Team Members</span>
      </a>
      <a class="nav-item {% if request.path.startswith('/trend') %}active{% endif %}"
         href="{{ url_for('trend') }}" title="Trends">
        <span class="nav-ico">üìà</span><span class="nav-label">Trends</span>
      </a>
      <a class="nav-item {% if request.path.startswith('/questions') %}active{% endif %}"
         href="{{ url_for('questions') }}" title="Questions">
        <span class="nav-ico">‚úçÔ∏è</span><span class="nav-label">Questions</span>
      </a>
      <a class="nav-item {% if request.path.startswith('/settings') %}active{% endif %}"
         href="{{ url_for('settings') }}" title="Settings">
        <span class="nav-ico">‚öôÔ∏è</span><span class="nav-label">Settings</span>
      </a>
      <a class="nav-item {% if request.path.startswith('/context') %}active{% endif %}"
         href="{{ url_for('context') }}" title="Context">
        <span class="nav-ico">üß≠</span><span class="nav-label">Context</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <button id="nav-toggle" class="nav-toggle" type="button" aria-expanded="true" title="Collapse sidebar">
        <span>üß±</span><span class="txt">Collapse</span>
      </button>
    </div>
  </aside>

  <!-- Main -->
  <main class="content">
    <!-- Sticky control bar -->
    <div style="position:sticky; top:0; z-index:5; padding:8px 0; margin-bottom:8px;">
      <div class="card" style="display:flex; align-items:center; justify-content:flex-end; gap:10px; padding:8px 12px;">

        <!-- Theme (cycles Light ‚Üí Dark ‚Üí Auto) -->
        <button id="wb-theme-toggle" class="btn ghost" type="button" title="Toggle theme"
                style="display:flex; align-items:center; gap:8px;">
          <span id="wb-theme-icon" aria-hidden="true">üåû</span>
          <span>Theme</span>
        </button>

        <span style="opacity:.25;">|</span>

        <!-- Bot toggle -->
        <div style="display:flex; align-items:center; gap:10px;">
          <strong id="bot-status-text">{{ 'Bot running' if bot_running else 'Bot stopped' }}</strong>
          <label class="switch" style="margin:0;">
            <input id="bot-toggle" type="checkbox" {% if bot_running %}checked{% endif %}>
            <span class="slider"></span>
          </label>
        </div>

        {% if authed %}
        <span style="opacity:.25;">|</span>
        <!-- Logout -->
        <a href="{{ url_for('logout') }}" class="btn ghost" title="Logout" style="display:flex;align-items:center;gap:8px;">
          üö™ <span>Logout</span>
        </a>
        {% endif %}
      </div>
    </div>

    <!-- Flash messages -->
    <div class="flash-container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="flash {{ 'flash-' + category if category in ['success','warning','danger'] else '' }}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    {% block content %}{% endblock %}
  </main>
</div>

<!-- Theme + Sidebar + Bot scripts -->
<script>
  // THEME (uses theme_api from Flask context processor)
  (function () {
    const KEY = 'wb-theme';
    const DEFAULT = "{{ (settings.theme or 'Light') }}";
    const ORDER = ['Light','Dark','Auto'];
    const API = "{{ theme_api }}";
    const prefers = () => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

    function apply(mode) {
      const dark = (mode === 'Dark') || (mode === 'Auto' && prefers());
      document.documentElement.classList.toggle('dark', dark);
      document.body.classList.toggle('dark', dark);
      const ic = document.getElementById('wb-theme-icon');
      if (ic) ic.textContent = dark ? 'üåô' : 'üåû';
      document.querySelectorAll('#theme-segmented input[type=radio]').forEach(r => r.checked = (r.value === mode));
    }

    window.setTheme = async function(mode) {
      try { localStorage.setItem(KEY, mode); } catch(_) {}
      apply(mode);
      try {
        if (API && API !== '#') {
          await fetch(API, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ theme: mode }) });
        }
      } catch(_) {}
    };

    const btn = document.getElementById('wb-theme-toggle');
    btn && btn.addEventListener('click', () => {
      const cur = (localStorage.getItem(KEY) || DEFAULT);
      const next = ORDER[(ORDER.indexOf(cur) + 1) % ORDER.length];
      window.setTheme(next);
    });

    apply(localStorage.getItem(KEY) || DEFAULT);

    const mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
    mq && mq.addEventListener && mq.addEventListener('change', () => {
      const cur = localStorage.getItem(KEY) || DEFAULT;
      if (cur === 'Auto') apply('Auto');
    });
  })();
</script>

<script>
  // SIDEBAR COLLAPSE
  (function () {
    const root = document.documentElement;
    const btn = document.getElementById('nav-toggle');
    const KEY = 'wb-nav-collapsed';
    function setCollapsed(on){
      root.classList.toggle('nav-collapsed', on);
      btn && btn.setAttribute('aria-expanded', String(!on));
      try { localStorage.setItem(KEY, on ? 'true' : 'false'); } catch(_){}
      if (btn) btn.title = on ? 'Expand sidebar' : 'Collapse sidebar';
      if (btn) btn.querySelector('.txt') && (btn.querySelector('.txt').textContent = on ? 'Expand' : 'Collapse');
    }
    // init
    let collapsed = false;
    try { collapsed = (localStorage.getItem(KEY) === 'true'); } catch(_){}
    setCollapsed(collapsed);
    btn && btn.addEventListener('click', () => setCollapsed(!root.classList.contains('nav-collapsed')));
  })();
</script>

<script>
  // BOT START/STOP
  (function () {
    const toggle = document.getElementById('bot-toggle');
    const label = document.getElementById('bot-status-text');
    if (!toggle) return;
    toggle.addEventListener('change', async (e) => {
      const on = e.target.checked;
      try {
        const resp = await fetch(on ? "{{ url_for('bot_start') }}" : "{{ url_for('bot_stop') }}", {
          method: 'POST', headers: {'X-Requested-With':'fetch'}
        });
        if (!resp.ok) throw new Error('Request failed');
        if (label) label.textContent = on ? 'Bot running' : 'Bot stopped';
      } catch (err) {
        alert('Could not toggle bot. Check server logs and Slack tokens.');
        e.target.checked = !on; // revert UI
      }
    });
  })();
</script>

</body>
</html>
